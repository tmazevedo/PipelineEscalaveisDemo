name: "ğŸš€ Demo Pipelines Escalaveis"

on:
  workflow_dispatch: # Disparo manual 

permissions:
  id-token: write
  contents: read
jobs:
  infra-creation:
    runs-on: [self-hosted, pipeline-escalavel-demo]
    steps:
          - name: ğŸ”‘ Azure Login
            uses: azure/login@v2
            with:
              client-id: 33e3541d-1b43-4a99-92ed-b6cce31b1df8
              tenant-id: 7b3576f3-a15e-442a-91f4-f0109642be20
              subscription-id: 67f1680f-e19d-4ee7-8786-aed946e04cfb

          - name: ğŸ—ï¸ Setup App Service Plan & WebApp
            run: |
              # Usando o seu RG existente: demo-pipelines-esclaveis
              echo "Verificando Infraestrutura..."
              az appservice plan create --name plan-demo-escalavel --resource-group demo-pipelines-escalaveis --sku B1 --is-linux || echo "Plan existe."
              az webapp create --name webapp-demo-pipeline --resource-group demo-pipelines-esclaveis --plan plan-demo-escalavel --runtime "NODE:20-lts" || echo "App existe."   
  pipeline:
    needs: infra-creation
    # label do seu Runner Set do ARC
    runs-on: [self-hosted, pipeline-escalavel-demo]
    defaults:
      run:
        working-directory: apps/api

    strategy:
      matrix:
        instance: [1, 2, 3] # Escala 3 pods simultÃ¢neos no AKS

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”‘ Azure Login 
        uses: azure/login@v2
        with:
          client-id: 33e3541d-1b43-4a99-92ed-b6cce31b1df8
          tenant-id: 7b3576f3-a15e-442a-91f4-f0109642be20
          subscription-id: 67f1680f-e19d-4ee7-8786-aed946e04cfb

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          cache-dependency-path: apps/api/package-lock.json

      - name: ğŸ“¦ Install & Prisma
        run: |
          npm ci
          npx prisma generate

      - name: ğŸ§ª Real Vitest & Scalability Await
        run: |
          echo "Iniciando testes reais na instÃ¢ncia ${{ matrix.instance }}..."
          npm test -- --run
          echo "--- AGUARDANDO 40S PARA DEMO DE ESCALA ---"
          sleep 40 

      - name: ğŸ—ï¸ Build Nitro
        run: npm run build

      - name: ğŸš€ Deploy to App Service
        if: matrix.instance == 1 # Apenas uma instÃ¢ncia faz o deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'webapp-demo-pipeline'
          package: apps/api/.output