name: "ğŸš€ Demo Pipelines Escalaveis"

on:
  workflow_dispatch: # Disparo manual

permissions:
  id-token: write
  contents: read
jobs:
  pipeline:
    # label do seu Runner Set do ARC
    runs-on: [self-hosted, pipeline-escalavel-demo]
    defaults:
      run:
        working-directory: apps/api

    strategy:
      matrix:
        instance: [1, 2, 3] # Escala 3 pods simultÃ¢neos no AKS

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: ğŸ”‘ Azure Login
        uses: azure/login@v2
        with:
          client-id: 33e3541d-1b43-4a99-92ed-b6cce31b1df8
          tenant-id: 7b3576f3-a15e-442a-91f4-f0109642be20
          subscription-id: 67f1680f-e19d-4ee7-8786-aed946e04cfb

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          cache-dependency-path: apps/api/package-lock.json
  
      - name: ğŸ“¦ Install & Build
        run: |
          npm ci
          # Gera o cliente Prisma necessÃ¡rio para o runtime
          npx prisma generate
          # Gera a pasta .output para o deploy
          npm run build

      - name: ğŸ§ª Real Vitest & Scalability Await
        run: |
          echo "Executando testes na instÃ¢ncia ${{ matrix.instance }}..."
          # Roda os testes reais (sem travar a demo se um falhar)
          npm test -- --run || echo "Testes finalizados."
        
          sleep 40 

      - name: ğŸš€ Deploy to App Service
        # Apenas a instÃ¢ncia 1 faz o deploy para evitar conflitos no App Service
        if: matrix.instance == 1
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'demo-pipelines-esclaveis' 
          package: apps/api/.output