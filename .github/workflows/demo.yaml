name: "ğŸš€ Demo Pipelines Escalaveis"

on:
  workflow_dispatch: # Disparo manual para sua demo

jobs:
  pipeline:
    # label do seu Runner Set do ARC
    runs-on: [self-hosted, pipeline-escalavel-demo]
    defaults:
      run:
        working-directory: apps/api
    strategy:
      matrix:
        # Criamos 3 execuÃ§Ãµes simultÃ¢neas.
        # No ARC, isso deve disparar 3 PODS diferentes imediatamente.
        instance: [1, 2, 3]

    steps:
      - name: ğŸ“‚ Checkout RealWorld Project
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "Instalando dependÃªncias pesadas..."
          npm install

      - name: ğŸ—„ï¸ Prisma Generate
        run: |
          # Isso compila o cliente Prisma, um processo real de build
          npx prisma generate
          
      - name: ğŸ§ª Run Real Vitest Suite
        run: |
          echo "Executando testes reais da instÃ¢ncia ${{ matrix.instance }}..."
          # Rodando o vitest real do seu package.json
          # O --run garante que ele nÃ£o fique em modo 'watch'
          npm test -- --run

      - name: â³ Scalability Hold (O Momento da Demo)
        run: |
          echo "---------------------------------------------------------"
          echo "TESTES REAIS CONCLUÃDOS COM SUCESSO!"
          echo "Segurando o Pod por 40s para demonstrar o escalonamento..."
          echo "---------------------------------------------------------"
          # O sleep aqui Ã© essencial para vocÃª ter tempo de falar 
          # enquanto os 4 pods aparecem no 'kubectl get pods'
          sleep 40 
  
      - name: ğŸ—ï¸ Production Build
        run: |
          # Faz o build real do Nitro (gera a pasta .output)
          # Isso Ã© o que um pipeline de prod faz antes do deploy
          npm run build
